# 서브쿼리

## 서브쿼리  
- 하나의 SQL문안에 포함되어 있는 또 다른 SQL문을 말함 - 반드시 괄호로 묶어야 함  
   ex) SELECT 안에 SELECT문, INSERT, UPDATE, DELETE 안의 SELECT문 

## 서브쿼리 종류
### 1. 스칼라 서브쿼리
- SELECT 에 사용하는 서브 쿼리
- 서브쿼리 결과를 마치 **하나의 컬럼처럼 사용하기 위해 주로 사용**

### 2. 인라인뷰
- FROM 절에 사용하는 서브쿼리
- **서브쿼리 결과를 테이블 처럼 사용하기 위해 주로 사용**

### 3. WHERE절 서브쿼리
- 가장 일반적인 서브쿼리
- 비교 상수 자리에 **값을 전달하기 위한 모적으로 주요 사용**

## WHERE 절 서브쿼리 종류
### 1. 단일행 서브 쿼리
- **서브쿼리 결과가 1개의 행이 리턴**되는 형태 
- 단일행 서브쿼리 연산자 종류

| 연산자 |   의미   |
|:----|:------:|
| =   |   같다   |
| <>  | 같지 않다  |
| >   |   크다   |
| >=  | 크거나 같다 |
| <   |   작다   |
| <=  | 작거나 같다 |


### 에시
```
SELECT EMPNO, ENAME, SAL
FROM EMP
WHERE SAL > (SELECT AVG(SAL)
             FROM EMP);
```

### 2. 다중행 서브쿼리
- **서브쿼리 결과가 여러 행이 리턴되는 형태**
- ‘=’, ‘>’, ‘<’와 같은 비교 연산자 사용불가(여러 값이랑 비교할 수 없는 연산자들) 
- - 서브쿼리 결과를 하나로 요약하거나 다중행 서브쿼리 연산자를 사용

| 연산자   |    의미    |
|:------|:--------:|
| IN    | 같은 값을 찾음 |
| > ANY | 최소값을 반환함 |
| < ANY | 최대값을 반환함 |
| < ALL | 최소값을 반환함 |
| > ALL | 최대값을 반환함 |

### 예제) ALL과 ANY 비교
> > ALL(2000, 3000) : 최대값(3000)보다 큰 행들 반환  
> < ALL(2000, 3000) : 최소값(2000)보다 작은 행들 반환  
> > ANY(2000, 3000) : 최소값(2000)보다 큰 행들 반환  
> < ANY(2000, 3000) : 최대값(3000)보다 작은 행들 반환

### 3. 다중컬럼 서브쿼리  
- 서브쿼리 결과가 여러 컬럼이 리턴되는 형태 
- 메인쿼리와의 비교 컬럼이 2개 이상 
- 대소 비교 전달 불가(두 값을 동시에 묶어 대소비교 할 수 없음)

### 예시 (메인쿼리에 비교 대상으로 서브쿼리 결과 전달)
```
SELECT EMPNO, ENAME, SAL, DEPTNO
FROM EMP
WHERE (DEPTNO, SAL) IN (SELECT DEPTNO, MAX(SAL)
                        FROM EMP
                        GROUP BY DEPTNO);
```

### 4. 상호연관 서브쿼리
- 메인쿼리와 서브쿼리의 비교를 수행하는 형태 
- 비교할 집단이나 조건은 서브쿼리에 명시(메인쿼리절에는 서브쿼리 컬럼이 정의되지 않았기 때문에 에러 발생

### 예시 ( 대소 비교할 컬럼을 메인쿼리에, 일치 조건을 서브쿼리에 전달)
```
SELECT EMPNO, ENAME, SAL, DEPTNO
FROM EMP E1
WHERE SAL > (SELECT AVG(SAL)
             FROM EMP E2
             WHERE E1.DEPTNO = E2.DEPTNO
             GROUP BY DEPTNO);
```

## 인라인뷰(Inline View)

- **쿼리 안의 뷰의 형태로 테이블처럼 조회할 데이터를 정의하기 위해 사용** 
- 테이블명이 존재하지 않기 때문에 다른 테이블과 조인 시 반드시 테이블 별칭 명시(단독으로 사용하는 경우 불필요)  
- WHERE절 서브쿼리와 다르게 **서브쿼리 결과를 메인 쿼리의 어느 절에서도 사용할 수 있음** 
- 인라인뷰의 결과와 메인쿼리 테이블과 조인할 목적으로 주로 사용 
- 모든 연산자 사용 가능

## 스칼라 서브쿼리 
- SELECT절에 사용하는 쿼리로, 마치 하나의 컬럼처럼 표현하기 위해 사용 (단 하나의 출력 대상만 표현 가능) 
- 각 행마다 스칼라 서브쿼리 결과가 하나여야 함(단일행 서브쿼리 형태) 
- 조인의 대체 연산 

# 집합 연산자

## 집합 연산자 
- SELECT문 결과를 하나의 집합으로 간주, 그 집합에 대한 합집합, 교집합, 차집합 연산 
- SELECT문과 SELECT문 사이에 집합 연산자 정의 
- 두 집합의 컬럼이 동일하게 구성되어야 함(각 컬럼의 데이터 타입과 순서 일치 필요) 
- 전체 집합의 데이터타입과 컬럼명은 첫번째 집합에 의해 결정됨
- 
## 합집합 
- 두 집합의 총 합(전체) 출력 
- UNION과 UNION ALL 사용 가능
### 1. UNION 
- 중복된 데이터는 한 번만 출력 
- 중복된 데이터를 제거하기 위해 내부적으로 정렬 수행 
- 중복된 데이터가 없을경우는 UNION 사용 대신 UNION ALL 사용(불필요한 정렬 발생할 수 있으므로)
### 2. UNION ALL 
- 중복된 데이터도 전체 출력

## 차집합 
- 두 집합 사이에 MINUS 전달 
- 두 집합의 차집합(한 쪽 집합에만 존재하는 행) 출력 
- A-B와 B-A는 다르므로 집합의 순서 주의